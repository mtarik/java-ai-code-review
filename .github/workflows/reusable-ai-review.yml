name: ğŸ¤– Reusable AI Code Review - Java

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Version de Java Ã  utiliser'
        required: false
        type: string
        default: '17'
      build-tool:
        description: 'Outil de build (maven, gradle, ou auto)'
        required: false
        type: string
        default: 'auto'
      enable-static-analysis:
        description: 'Activer Checkstyle, PMD, SpotBugs'
        required: false
        type: boolean
        default: true
      post-pr-comment:
        description: 'Poster un commentaire sur la PR'
        required: false
        type: boolean
        default: true
      fail-on-critical:
        description: 'Ã‰chouer le workflow si problÃ¨mes critiques'
        required: false
        type: boolean
        default: false
    secrets:
      ANTHROPIC_API_KEY:
        description: 'ClÃ© API Anthropic pour Claude'
        required: true

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'

      - name: ğŸ“¦ Cache Maven
        if: inputs.build-tool == 'maven' || inputs.build-tool == 'auto'
        uses: actions/cache@v3
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: ğŸ“¦ Cache Gradle
        if: inputs.build-tool == 'gradle' || inputs.build-tool == 'auto'
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: ğŸ” Identifier les fichiers Java modifiÃ©s
        id: changed-files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff --name-only origin/${{ github.base_ref }}...${{ github.sha }} | grep '\.java$' > changed_files.txt || true
          else
            git diff --name-only HEAD~1 HEAD | grep '\.java$' > changed_files.txt || true
          fi

          if [ -s changed_files.txt ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Fichiers Java modifiÃ©s :"
            cat changed_files.txt
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Aucun fichier Java modifiÃ©"
          fi

      - name: â˜• Compilation du projet Java
        if: steps.changed-files.outputs.found == 'true'
        run: |
          BUILD_TOOL="${{ inputs.build-tool }}"

          # Auto-dÃ©tection
          if [ "$BUILD_TOOL" == "auto" ]; then
            if [ -f "pom.xml" ]; then
              BUILD_TOOL="maven"
            elif [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
              BUILD_TOOL="gradle"
            fi
          fi

          # Compilation
          if [ "$BUILD_TOOL" == "maven" ]; then
            echo "ğŸ”¨ Compilation avec Maven..."
            mvn clean compile -B -q || echo "âš ï¸ Avertissement: Erreur de compilation"
          elif [ "$BUILD_TOOL" == "gradle" ]; then
            echo "ğŸ”¨ Compilation avec Gradle..."
            chmod +x gradlew || true
            ./gradlew compileJava -q || echo "âš ï¸ Avertissement: Erreur de compilation"
          else
            echo "â„¹ï¸ Aucun systÃ¨me de build dÃ©tectÃ©"
          fi
        continue-on-error: true

      - name: ğŸ” Analyse statique
        if: steps.changed-files.outputs.found == 'true' && inputs.enable-static-analysis
        run: |
          if [ -f "pom.xml" ]; then
            echo "ğŸ“‹ ExÃ©cution de Checkstyle..."
            mvn checkstyle:check || echo "âš ï¸ ProblÃ¨mes Checkstyle dÃ©tectÃ©s"
            echo "ğŸ” ExÃ©cution de PMD..."
            mvn pmd:check || echo "âš ï¸ ProblÃ¨mes PMD dÃ©tectÃ©s"
          fi
        continue-on-error: true

      - name: ğŸ Setup Python
        if: steps.changed-files.outputs.found == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ğŸ“¥ TÃ©lÃ©charger le script AI Reviewer
        if: steps.changed-files.outputs.found == 'true'
        run: |
          mkdir -p scripts
          curl -sSL https://raw.githubusercontent.com/${{ github.repository_owner }}/java-ai-code-review/main/scripts/ai_code_reviewer.py \
            -o scripts/ai_code_reviewer.py
          curl -sSL https://raw.githubusercontent.com/${{ github.repository_owner }}/java-ai-code-review/main/scripts/requirements.txt \
            -o scripts/requirements.txt
          chmod +x scripts/ai_code_reviewer.py

      - name: ğŸ“¦ Installer les dÃ©pendances Python
        if: steps.changed-files.outputs.found == 'true'
        run: |
          pip install -r scripts/requirements.txt

      - name: ğŸ¤– Analyse IA avec Claude
        if: steps.changed-files.outputs.found == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_NAME: ${{ github.repository }}
          COMMIT_SHA: ${{ github.sha }}
        run: |
          echo "ğŸ§  Lancement de l'analyse IA..."
          python scripts/ai_code_reviewer.py

      - name: ğŸ“Š Upload du rapport
        if: always() && steps.changed-files.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-report-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            code_review_*.md
            code_review_*.json
            review_report.json
            review_report.md
          retention-days: 30

      - name: ğŸ’¬ CrÃ©er un Review avec commentaires sur les lignes
        if: github.event_name == 'pull_request' && steps.changed-files.outputs.found == 'true' && inputs.post-pr-comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Lire le rapport JSON
            const files = fs.readdirSync('.');
            const jsonFile = files.find(f => f.startsWith('code_review_') && f.endsWith('.json'));

            if (!jsonFile || !fs.existsSync(jsonFile)) {
              console.log('âš ï¸ Aucun rapport JSON trouvÃ©');
              return;
            }

            const reviewData = JSON.parse(fs.readFileSync(jsonFile, 'utf8'));

            // RÃ©cupÃ©rer les fichiers modifiÃ©s dans la PR avec leurs lignes changÃ©es
            const prNumber = context.issue.number;
            const { data: prFiles } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // Construire une map des lignes modifiÃ©es par fichier
            const modifiedLines = {};
            for (const file of prFiles) {
              const lines = new Set();

              // Parser le patch pour extraire les numÃ©ros de lignes modifiÃ©es
              if (file.patch) {
                const patchLines = file.patch.split('\n');
                let currentLine = 0;

                for (const line of patchLines) {
                  if (line.startsWith('@@')) {
                    // Extraire le numÃ©ro de ligne de dÃ©part: @@ -x,y +a,b @@
                    const match = line.match(/\+(\d+)/);
                    if (match) {
                      currentLine = parseInt(match[1]);
                    }
                  } else if (!line.startsWith('-')) {
                    // Ligne ajoutÃ©e ou contexte (pas supprimÃ©e)
                    if (line.startsWith('+') || line.startsWith(' ')) {
                      lines.add(currentLine);
                      currentLine++;
                    }
                  }
                }
              }

              modifiedLines[file.filename] = lines;
            }

            console.log('ğŸ“ Lignes modifiÃ©es par fichier:', Object.entries(modifiedLines).map(([f, lines]) => `${f}: ${lines.size} lignes`));

            const comments = [];
            const issuesNotOnModifiedLines = [];
            let summaryBody = '## ğŸ¤– Revue de Code IA - RÃ©sumÃ©\n\n';

            // IcÃ´nes pour les sÃ©vÃ©ritÃ©s
            const severityIcons = {
              'critical': 'ğŸ”´',
              'high': 'ğŸŸ ',
              'medium': 'ğŸŸ¡',
              'low': 'ğŸ”µ',
              'info': 'â„¹ï¸'
            };

            // Construire les commentaires sur les lignes modifiÃ©es uniquement
            for (const fileReview of reviewData.files || []) {
              const filePath = fileReview.path;
              summaryBody += `\n### ğŸ“„ ${filePath}\n`;
              summaryBody += `**Score**: ${fileReview.score || 'N/A'}/10\n\n`;

              const fileModifiedLines = modifiedLines[filePath] || new Set();
              let inlineCommentCount = 0;

              for (const issue of fileReview.issues || []) {
                if (issue.line) {
                  const icon = severityIcons[issue.severity] || 'â€¢';
                  const commentBody = `${icon} **${issue.severity?.toUpperCase() || 'INFO'}** - ${issue.title || 'ProblÃ¨me dÃ©tectÃ©'}\n\n${issue.description || ''}\n\n${issue.suggestion ? `ğŸ’¡ **Suggestion**: ${issue.suggestion}` : ''}`;

                  // VÃ©rifier si la ligne est dans le diff
                  if (fileModifiedLines.has(issue.line)) {
                    comments.push({
                      path: filePath,
                      line: issue.line,
                      side: 'RIGHT',
                      body: commentBody
                    });
                    inlineCommentCount++;
                  } else {
                    // Garder pour le rÃ©sumÃ©
                    issuesNotOnModifiedLines.push({
                      file: filePath,
                      line: issue.line,
                      icon: icon,
                      severity: issue.severity,
                      title: issue.title,
                      description: issue.description,
                      suggestion: issue.suggestion
                    });
                  }
                }
              }

              if (inlineCommentCount > 0) {
                summaryBody += `ğŸ“ ${inlineCommentCount} commentaire(s) postÃ©(s) sur les lignes modifiÃ©es\n\n`;
              }

              if (fileReview.issues?.length === 0) {
                summaryBody += 'âœ… Aucun problÃ¨me dÃ©tectÃ©\n\n';
              }
            }

            // Ajouter les problÃ¨mes non commentÃ©s inline au rÃ©sumÃ©
            if (issuesNotOnModifiedLines.length > 0) {
              summaryBody += '\n## âš ï¸ Autres ProblÃ¨mes DÃ©tectÃ©s\n\n';
              summaryBody += '_Ces problÃ¨mes concernent des lignes non modifiÃ©es dans cette PR_\n\n';

              for (const issue of issuesNotOnModifiedLines) {
                summaryBody += `${issue.icon} **${issue.file}:${issue.line}** - ${issue.title}\n`;
                summaryBody += `${issue.description}\n`;
                if (issue.suggestion) {
                  summaryBody += `ğŸ’¡ ${issue.suggestion}\n`;
                }
                summaryBody += '\n';
              }
            }

            // Ajouter le rÃ©sumÃ© global
            if (reviewData.summary) {
              summaryBody += `\n## ğŸ“Š RÃ©sumÃ© Global\n\n${reviewData.summary}\n\n`;
            }
            if (reviewData.overall_score) {
              summaryBody += `**Score Global**: ${reviewData.overall_score}/100\n\n`;
            }

            summaryBody += '\n---\n';
            summaryBody += `ğŸ” Commit: \`${context.sha.substring(0, 7)}\`\n`;
            summaryBody += `â° AnalysÃ© le: ${new Date().toLocaleString('fr-FR')}\n`;
            summaryBody += `ğŸ¤– PropulsÃ© par Claude Sonnet 4.5`;

            // CrÃ©er le review avec commentaires
            console.log(`ğŸ“ CrÃ©ation du review avec ${comments.length} commentaires inline et ${issuesNotOnModifiedLines.length} problÃ¨mes dans le rÃ©sumÃ©`);

            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'COMMENT',
                body: summaryBody,
                comments: comments
              });
              console.log('âœ… Review crÃ©Ã© avec succÃ¨s');
            } catch (error) {
              console.log('âš ï¸ Erreur lors de la crÃ©ation du review avec commentaires:', error.message);
              console.log('ğŸ“ Posting du rÃ©sumÃ© uniquement en commentaire');

              // Si les commentaires inline Ã©chouent, poster uniquement le rÃ©sumÃ©
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summaryBody
              });
            }

      - name: ğŸ” VÃ©rifier les problÃ¨mes critiques
        if: steps.changed-files.outputs.found == 'true' && inputs.fail-on-critical
        run: |
          if [ -f "code_review_"*.json ]; then
            CRITICAL_COUNT=$(python3 -c "
            import json
            import glob
            files = glob.glob('code_review_*.json')
            if files:
                with open(files[0]) as f:
                    data = json.load(f)
                    count = sum(len([i for i in f.get('issues', []) if i.get('severity') == 'critical']) for f in data.get('files', []))
                    print(count)
            else:
                print(0)
            ")

            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "âŒ $CRITICAL_COUNT problÃ¨me(s) critique(s) dÃ©tectÃ©(s)!"
              exit 1
            fi
          fi

      - name: âœ… RÃ©sumÃ©
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š RÃ‰SUMÃ‰ DE L'ANALYSE IA"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "${{ steps.changed-files.outputs.found }}" == "true" ]; then
            if ls code_review_*.json 1> /dev/null 2>&1; then
              echo "âœ… Revue de code terminÃ©e avec succÃ¨s"
              echo "ğŸ“ Rapport disponible dans les artefacts"
            else
              echo "âš ï¸ Aucun rapport gÃ©nÃ©rÃ©"
            fi
          else
            echo "â„¹ï¸ Aucun fichier Java Ã  analyser"
          fi

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
